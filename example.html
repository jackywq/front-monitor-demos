<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端监控 SDK 示例</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .demo-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .error-btn {
            background: #dc3545;
        }
        .error-btn:hover {
            background: #c82333;
        }
        .form-group {
            margin: 10px 0;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>前端监控 SDK 示例</h1>
    
    <div class="status info" id="status">
        监控 SDK 未初始化
    </div>

    <div class="demo-section">
        <h2>1. 初始化监控</h2>
        <button onclick="initMonitor()">初始化监控 SDK</button>
        <button onclick="destroyMonitor()">销毁监控</button>
        <button onclick="flushData()">立即上报数据</button>
        <button onclick="checkStatus()">检查状态</button>
    </div>

    <div class="demo-section">
        <h2>2. 错误监控测试</h2>
        <button onclick="testJSError()">触发 JavaScript 错误</button>
        <button onclick="testPromiseError()">触发 Promise 错误</button>
        <button onclick="testCustomError()">手动上报错误</button>
        <button onclick="testResourceError()">触发资源加载错误</button>
        <button onclick="testAPIError()">触发 API 错误</button>
    </div>

    <div class="demo-section">
        <h2>3. 性能监控测试</h2>
        <button onclick="testPerformance()">查看性能数据</button>
        <button onclick="testCustomPerformance()">手动上报性能数据</button>
    </div>

    <div class="demo-section">
        <h2>4. 用户行为监控测试</h2>
        <form id="testForm" onsubmit="return handleFormSubmit(event)">
            <div class="form-group">
                <label>用户名:</label>
                <input type="text" name="username" placeholder="请输入用户名">
            </div>
            <div class="form-group">
                <label>邮箱:</label>
                <input type="email" name="email" placeholder="请输入邮箱">
            </div>
            <div class="form-group">
                <label>消息:</label>
                <textarea name="message" placeholder="请输入消息"></textarea>
            </div>
            <button type="submit">提交表单</button>
        </form>
        
        <div style="margin-top: 20px;">
            <button onclick="testClickBehavior()">测试点击行为</button>
            <button onclick="testPageView()">模拟页面跳转</button>
        </div>
    </div>

    <div class="demo-section">
        <h2>5. 配置测试</h2>
        <button onclick="testIgnoreErrors()">测试忽略错误配置</button>
        <button onclick="testSampleRate()">测试采样率配置</button>
    </div>

    <script src="./monitor-sdk.js"></script>
    <script>
        let monitorInitialized = false;

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function initMonitor() {
            Monitor.init({
                reportUrl: 'https://httpbin.org/post', // 使用测试接口
                appId: 'demo-app',
                monitorErrors: true,
                monitorPerformance: true,
                monitorBehavior: true,
                sampleRate: 1.0,
                maxBatchSize: 5,
                reportInterval: 5000,
                ignoreErrors: [
                    'Ignored Error' // 测试忽略的错误
                ],
                userBehavior: {
                    click: true,
                    pageView: true,
                    formSubmit: true
                }
            });
            
            monitorInitialized = Monitor.isInitialized();
            if (monitorInitialized) {
                updateStatus('监控 SDK 初始化成功', 'success');
            } else {
                updateStatus('监控 SDK 初始化失败', 'error');
            }
        }

        function destroyMonitor() {
            if (monitorInitialized) {
                Monitor.destroy();
                monitorInitialized = false;
                updateStatus('监控 SDK 已销毁', 'info');
            } else {
                updateStatus('监控 SDK 未初始化', 'error');
            }
        }

        function flushData() {
            if (monitorInitialized) {
                Monitor.flush();
                updateStatus('数据已立即上报', 'success');
            } else {
                updateStatus('请先初始化监控 SDK', 'error');
            }
        }

        function checkStatus() {
            if (monitorInitialized) {
                const config = Monitor.getConfig();
                updateStatus(`监控已初始化 - AppID: ${config.appId}, 采样率: ${config.sampleRate}`, 'success');
            } else {
                updateStatus('监控 SDK 未初始化', 'error');
            }
        }

        function testJSError() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 触发一个 JavaScript 错误
            try {
                throw new Error('这是一个测试的 JavaScript 错误');
            } catch (error) {
                console.error('捕获到错误:', error);
                updateStatus('JavaScript 错误已触发并上报', 'success');
            }
        }

        function testPromiseError() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 触发一个未处理的 Promise 错误
            Promise.reject(new Error('这是一个测试的 Promise 错误'));
            updateStatus('Promise 错误已触发并上报', 'success');
        }

        function testCustomError() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 手动上报自定义错误
            try {
                throw new TypeError('这是一个自定义类型错误');
            } catch (error) {
                Monitor.reportError(error, {
                    customField: '自定义数据',
                    userId: '12345',
                    page: 'demo.html'
                });
                updateStatus('自定义错误已手动上报', 'success');
            }
        }

        function testResourceError() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 创建一个不存在的图片资源来触发资源加载错误
            const img = new Image();
            img.src = 'https://example.com/nonexistent-image.jpg';
            img.onerror = function() {
                updateStatus('资源加载错误已触发并上报', 'success');
            };
            document.body.appendChild(img);
        }

        function testAPIError() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 模拟一个 API 错误请求
            fetch('https://httpbin.org/status/404')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API 返回错误状态');
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('API 错误:', error);
                    updateStatus('API 错误已触发并上报', 'success');
                });
        }

        function testPerformance() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 手动触发性能数据上报
            Monitor.reportPerformance({
                customMetric: Math.random() * 100,
                pageLoadTime: performance.timing ? 
                    performance.timing.loadEventEnd - performance.timing.navigationStart : 0
            });
            
            updateStatus('性能数据已手动上报', 'success');
        }

        function testCustomPerformance() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 上报自定义性能指标
            Monitor.reportPerformance({
                userInteractionTime: Date.now() - performance.timing.navigationStart,
                memoryUsage: performance.memory ? performance.memory.usedJSHeapSize : 0
            }, {
                customTag: 'user_defined'
            });
            
            updateStatus('自定义性能数据已上报', 'success');
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return false;
            }
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // 这里可以添加表单验证逻辑
            console.log('表单提交数据:', data);
            
            updateStatus('表单提交行为已记录', 'success');
            
            // 重置表单
            event.target.reset();
            
            return false; // 阻止实际提交
        }

        function testClickBehavior() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 手动上报点击行为
            Monitor.reportBehavior('custom_click', {
                element: 'test_button',
                text: '测试按钮',
                timestamp: Date.now()
            });
            
            updateStatus('点击行为已手动上报', 'success');
        }

        function testPageView() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 模拟页面跳转（使用 history API）
            history.pushState({}, '', '/new-page');
            
            updateStatus('页面跳转行为已记录', 'success');
            
            // 延迟后返回原页面
            setTimeout(() => {
                history.back();
            }, 1000);
        }

        function testIgnoreErrors() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 这个错误应该被忽略（在配置中设置了忽略 "Ignored Error"）
            try {
                throw new Error('Ignored Error - 这个错误应该被忽略');
            } catch (error) {
                console.log('这个错误应该被忽略:', error.message);
            }
            
            // 这个错误应该被上报
            try {
                throw new Error('Normal Error - 这个错误应该被上报');
            } catch (error) {
                console.log('这个错误应该被上报:', error.message);
            }
            
            updateStatus('忽略错误配置测试完成', 'success');
        }

        function testSampleRate() {
            if (!monitorInitialized) {
                updateStatus('请先初始化监控 SDK', 'error');
                return;
            }
            
            // 测试采样率 - 连续触发多个错误
            for (let i = 0; i < 10; i++) {
                try {
                    throw new Error(`采样率测试错误 ${i}`);
                } catch (error) {
                    // 错误会被自动捕获和上报（根据采样率）
                }
            }
            
            updateStatus('采样率配置测试完成', 'success');
        }

        // 页面加载完成后自动初始化监控（可选）
        window.addEventListener('load', function() {
            // 可以在这里自动初始化，或者让用户手动初始化
            // initMonitor();
        });

        // 监听控制台输出，方便调试
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            // 可以在这里添加日志显示逻辑
        };
    </script>
</body>
</html>